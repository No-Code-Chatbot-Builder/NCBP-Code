import { Body, Controller, Get, Param, Post, UseInterceptors, UploadedFile } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { AppService } from './app.service';
import { PineconeService } from './pinecone/pinecone.service';
import { DynamoDbService } from './dynamo-db/dynamo-db.service';
import { S3Service } from './s3/s3.service';
import { CreateIndexRequestMetricEnum } from '@pinecone-database/pinecone';
import { basename } from 'path';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService, private pineconeService: PineconeService, private dynamoDbService: DynamoDbService, private s3Service: S3Service) {
 
  }

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  @Post("index") 
  async createIndex(@Body() body: {indexName: string, dimension: number, metric: CreateIndexRequestMetricEnum, tableName: string, workspaceId: string}): Promise<any> {
    const { indexName, dimension, metric, tableName, workspaceId } = body;
    const response = await this.pineconeService.createIndex(indexName, dimension, metric);
    
    return response;
  }

  @Post("dataset/:workspaceId")
  async createDataset(@Body() body: {name: string, description?: string}, @Param('workspaceId') workspaceId: string): Promise<any>
  {
    const {name, description } = body;
    
    const userId = "USER#123"; // Replace with req[user] after creating middleware
    const response = await this.dynamoDbService.createDataset( workspaceId, userId, name, description)
    return response
  }

  @Post("data/:workspaceId/:datasetId")@UseInterceptors(FileInterceptor('file'))
  async addData(@UploadedFile() file: Express.Multer.File, @Body() body: {url: string}, @Param('workspaceId') workspaceId: string, @Param('datasetId') datasetId: string): Promise<any> {
    const { url } = body

    

    let data:any;

    if (file)
    {
      data = file;
    }
    else if (url)
    {
      data = url;
    }
    const userId = "USER#123"; // Replace with req[user] after creating middleware

    const response = await this.dynamoDbService.addData(data, userId, workspaceId, datasetId)
    return response;

  }


  // @Post("s3")
  // async postS3(): Promise<any>
  // {
  //   const bucketName = "ncbp-bucket";
  //   const filePath = "bitcoin.pdf";
  //   const userId = "userId"
  //   const workspaceId = "workspaceId";
  //   const response = await this.s3Service.uploadFileToS3(bucketName, filePath, userId, workspaceId);
  //   return response;
  // }
  @Get("s3")
  async getS3(): Promise<any>
  {
    const bucketName = "ncbp-bucket";
    const filePath = "bitcoin.pdf";
    const userId = "userId"
    const workspaceId = "workspaceId";
    const response = await this.s3Service.getFileFromS3(bucketName, filePath, userId, workspaceId);
    return response;
  }
  // @Post("dataset")
  // async dataset(): Promise<any> {
  //   const datasetRecord = {
  //     id: "datasetId",
  //     name: "Dataset Name",
  //     description: "Dataset Description",
  //     workspaceId: "workspaceId",
  //     data: [
  //       {
  //         id: "dataId1",
  //         type: "file",
  //         path: "https://s3:pathfile",
  //       },
  //       {
  //         id: "dataId2",
  //         type: "text",
  //         content: "Hello world This is NCBP",
  //       },
  //       {
  //         id: "dataId3",
  //         type: "website",
  //         url: "https://www.google.com",
  //       },
  //       // ... other data items
  //     ],
  //   };
    
  //   await this.dynamoDbService.addDatasetRecord('ncbp', datasetRecord);
  // }
  @Post("embedVectors")
  async embedVectors(): Promise<any> {
    const indexName = "test-index";

    await this.pineconeService.upsertRecords(indexName);
  }
}

// const vecEmbeddings = ([{
//   id: '1234',
//   values:
//     [
//         0.005593450739979744,
//         0.0720367357134819,
//         -0.029577849432826042,
//         0.016925090923905373,
//         0.037830110639333725,
//         0.043387699872255325,
//         0.07376430928707123,
//         0.042455043643713,
//         0.04841351509094238,
//         -0.01946515403687954,
//         0.02557043917477131,
//         -0.003586066886782646,
//         0.02238571271300316,
//         -0.03815307468175888,
//         0.05184832587838173,
//         0.036010436713695526,
//         0.05260832980275154,
//         0.0011846063425764441,
//         -0.03756660595536232,
//         -0.05119312182068825,
//         0.03419174253940582,
//         0.04148734733462334,
//         0.06025495007634163,
//         0.021357934921979904,
//         0.015297437086701393,
//         0.08731621503829956,
//         -0.005019805394113064,
//         0.0585143156349659,
//         0.08745531737804413,
//         -0.03284282609820366,
//         -0.0005656011053360999,
//         0.04590034484863281,
//         0.14108170568943024,
//         0.011869055218994617,
//         0.07741469144821167,
//         0.005586037412285805,
//         -0.08438549935817719,
//         0.06323327124118805,
//         0.019169434905052185,
//         0.056751471012830734,
//         -0.021942108869552612,
//         -0.050580184906721115,
//         -0.011278755031526089,
//         0.03019452467560768,
//         0.08737757802009583,
//         -0.058349449187517166,
//         -0.06932507455348969,
//         0.029690034687519073,
//         0.04098600149154663,
//         0.0966460257768631,
//         -0.08690831810235977,
//         -0.040869347751140594,
//         -0.05128153786063194,
//         -0.03064039908349514,
//         -0.017100052908062935,
//         0.042303889989852905,
//         0.03289200738072395,
//         -0.07166525721549988,
//         0.004963757004588842,
//         -0.044368498027324677,
//         -0.00683099078014493,
//         0.0015901033766567707,
//         -0.03202270343899727,
//         0.009859362617135048,
//         0.040897347033023834,
//         0.012262620031833649,
//         -0.015903394669294357,
//         0.09114831686019897,
//         -0.0282005425542593,
//         -0.04487117752432823,
//         -0.049297645688056946,
//         0.05015363171696663,
//         0.018188994377851486,
//         0.13286209106445312,
//         -0.06591659039258957,
//         -0.0021071303635835648,
//         -0.08925162255764008,
//         -0.10496588051319122,
//         0.03292775899171829,
//         -0.03301963210105896,
//         -0.023137390613555908,
//         -0.019365092739462852,
//         0.04547741636633873,
//         0.11157266050577164,
//         -0.010004550218582153,
//         0.034015510231256485,
//         0.0499437041580677,
//         0.05678168684244156,
//         -0.01563773676753044,
//         0.006731059867888689,
//         -0.013997210189700127,
//         -0.022733313962817192,
//         0.04195420444011688,
//         -0.01725306361913681,
//         -0.13148880004882812,
//         0.0566861666738987,
//         -0.034941416233778,
//         -0.07546642422676086,
//         0.060999754816293716,
//         0.15369954705238342,
//         0.03142596781253815,
//         -0.004400661215186119,
//         0.03678879141807556,
//         0.012173280119895935,
//         -0.1363953799009323,
//         -0.09360658377408981,
//         0.05732102319598198,
//         -0.06186363473534584,
//         0.04309098795056343,
//         -0.02612958289682865,
//         0.03472904860973358,
//         -0.036239832639694214,
//         -0.09583000093698502,
//         -0.07093602418899536,
//         0.0537375882267952,
//         -0.11974197626113892,
//         0.004906302317976952,
//         -0.07565214484930038,
//         -0.013796142302453518,
//         0.02503516711294651,
//         -0.03693858161568642,
//         0.013316994532942772,
//         -0.11234623938798904,
//         0.01341469120234251,
//         -0.025816012173891068,
//         -0.020245173946022987,
//         0.0886596143245697,
//         -2.2934111516313762e-33,
//         0.011649178341031075,
//         -0.010498630814254284,
//         0.040928956121206284,
//         0.0997333973646164,
//         0.0227728970348835,
//         -0.009596412070095539,
//         -0.07157991081476212,
//         -0.04061164706945419,
//         -0.04173628240823746,
//         0.01409884262830019,
//         0.041793450713157654,
//         -0.08951207250356674,
//         0.03630660101771355,
//         0.034773606806993484,
//         -0.04097970947623253,
//         -0.049371540546417236,
//         -0.04319607466459274,
//         0.04603586718440056,
//         0.009357735514640808,
//         -0.0008352931472472847,
//         -0.05524924769997597,
//         0.02505863457918167,
//         0.06264017522335052,
//         -0.006138111464679241,
//         -0.038244277238845825,
//         0.04801876097917557,
//         -0.0007656534435227513,
//         -0.036395661532878876,
//         -0.0062368870712816715,
//         -0.01763540506362915,
//         -0.0017938307719305158,
//         -0.03378431499004364,
//         0.041204337030649185,
//         -0.016231611371040344,
//         0.010081305168569088,
//         0.04689432680606842,
//         0.03745315596461296,
//         0.0008101851562969387,
//         0.026620661839842796,
//         0.014162776060402393,
//         -0.02555277943611145,
//         0.00047820506733842194,
//         0.16480477154254913,
//         -0.040882669389247894,
//         0.012347942218184471,
//         0.02233191952109337,
//         -0.03395860269665718,
//         -0.010036570951342583,
//         0.04099388048052788,
//         -0.011970223858952522,
//         -0.006840461865067482,
//         0.05349530652165413,
//         -0.018038500100374222,
//         0.02545272931456566,
//         0.08139161020517349,
//         0.03266388177871704,
//         -0.005452686920762062,
//         0.0306779183447361,
//         0.020031681284308434,
//         0.055997367948293686,
//         -0.005234367214143276,
//         0.04233287647366524,
//         0.003578988602384925,
//         0.03393561393022537,
//         0.08234433829784393,
//         0.014504562132060528,
//         -0.03943951800465584,
//         -0.12599486112594604,
//         0.069998599588871,
//         -0.008873862214386463,
//         -0.02750648930668831,
//         -0.05060257762670517,
//         -0.07824426144361496,
//         -0.033821623772382736,
//         -0.07427297532558441,
//         -0.017233144491910934,
//         -0.002145362552255392,
//         0.015097170136868954,
//         -0.018598642200231552,
//         0.00401693070307374,
//         -0.03007141314446926,
//         -0.12163851410150528,
//         0.017216842621564865,
//         -0.08652972429990768,
//         -0.00683004641905427,
//         0.019199088215827942,
//         0.052974481135606766,
//         -0.16780412197113037,
//         0.060822125524282455,
//         -0.032214198261499405,
//         -0.06945730745792389,
//         0.002024654997512698,
//         -0.0855805054306984,
//         -0.0461902879178524,
//         0.06545798480510712,
//         1.377623635017553e-33,
//         0.011162914335727692,
//         0.014662559144198895,
//         -0.022660473361611366,
//         0.07821023464202881,
//         0.041776902973651886,
//         0.07426836341619492,
//         0.040503837168216705,
//         0.01609938219189644,
//         0.03813144937157631,
//         0.010274233296513557,
//         -0.039580266922712326,
//         0.020451176911592484,
//         0.02389928326010704,
//         -0.06589525938034058,
//         -0.03676711395382881,
//         0.027638062834739685,
//         0.05353993922472,
//         0.020660076290369034,
//         -0.00010275293607264757,
//         0.014641042798757553,
//         -0.07763927429914474,
//         -0.014799535274505615,
//         -0.030049292370676994,
//         -0.017897292971611023,
//         0.046669233590364456,
//         0.03708262741565704,
//         0.0011054243659600616,
//         0.0023359348997473717,
//         0.013480039313435555,
//         -0.06348619610071182,
//         -0.0379786491394043,
//         -0.031466882675886154,
//         0.012633453123271465,
//         0.04482328146696091,
//         -0.04829154908657074,
//         -0.030062802135944366,
//         0.11312668025493622,
//         -0.017408981919288635,
//         -0.021827010437846184,
//         0.06186246499419212,
//         0.07310764491558075,
//         0.027147825807332993,
//         -0.011283623054623604,
//         -0.02912929840385914,
//         -0.05649540200829506,
//         -0.0007744369213469326,
//         -0.11204338818788528,
//         -0.045248594135046005,
//         0.04785599559545517,
//         0.03246733546257019,
//         -0.0342361256480217,
//         -0.014228720217943192,
//         -0.06977999210357666,
//         -0.04912863299250603,
//         -0.029614463448524475,
//         -0.06571215391159058,
//         -0.03927639126777649,
//         -0.0015076507115736604,
//         0.009297877550125122,
//         0.014268948696553707,
//         -0.0836944580078125,
//         0.05233442783355713,
//         -0.02858220413327217,
//         -0.028838766738772392,
//         0.09149385243654251,
//         -0.09742781519889832,
//         -0.006558612454682589,
//         -0.022353973239660263,
//         -0.05477377027273178,
//         -0.006856274325400591,
//         0.023330794647336006,
//         -0.02350381202995777,
//         -0.02898566983640194,
//         -0.02855263464152813,
//         0.005069884937256575,
//         0.016135195270180702,
//         -0.021605780348181725,
//         0.03213336318731308,
//         -0.08750766515731812,
//         -0.048854760825634,
//         0.10397962480783463,
//         0.023703955113887787,
//         -0.016267746686935425,
//         0.102671317756176,
//         0.025872131809592247,
//         0.055759675800800323,
//         -0.029219258576631546,
//         -0.01666853204369545,
//         -0.0193930771201849,
//         0.04490348696708679,
//         -0.029009167104959488,
//         0.028406241908669472,
//         0.08557940274477005,
//         0.0911354050040245,
//         -0.01823541335761547,
//         -1.2587927145091271e-08,
//         -0.03025771863758564,
//         -0.06489541381597519,
//         0.0025738724507391453,
//         0.04525109753012657,
//         -0.01434363890439272,
//         0.026978477835655212,
//         -0.007481596432626247,
//         -0.09430746734142303,
//         -0.028683369979262352,
//         -0.059847742319107056,
//         0.03811783343553543,
//         -0.047677505761384964,
//         -0.058705396950244904,
//         -0.041237857192754745,
//         0.01603001356124878,
//         0.004182346630841494,
//         -0.007181729655712843,
//         0.000760667200665921,
//         0.003969504497945309,
//         -0.030279316008090973,
//         0.05248628929257393,
//         0.090866819024086,
//         -0.046468693763017654,
//         -0.0033193998970091343,
//         -0.02580837346613407,
//         0.08833093196153641,
//         -0.036385975778102875,
//         0.015934079885482788,
//         -0.017558390274643898,
//         -0.05838801711797714,
//         0.055608924478292465,
//         0.0369919091463089,
//         -0.0069097550585865974,
//         -0.04193376004695892,
//         0.09822428226470947,
//         -0.037033721804618835,
//         0.029722832143306732,
//         -0.02826699987053871,
//         0.03295990824699402,
//         -0.007454508915543556,
//         -0.013575909659266472,
//         0.04331006854772568,
//         -0.0866357684135437,
//         -0.04381563141942024,
//         0.04018862545490265,
//         -0.012496338225901127,
//         -0.006776822730898857,
//         -0.11256605386734009,
//         0.010219788178801537,
//         -0.024066194891929626,
//         -0.020257215946912766,
//         -0.029914824292063713,
//         0.0435592457652092,
//         -0.011634157039225101,
//         -0.020869676023721695,
//         0.016613269224762917,
//         0.09026598185300827,
//         0.08503789454698563,
//         -0.03306858241558075,
//         0.0186633188277483,
//         0.09587675333023071,
//         0.08872952312231064,
//         0.00981107633560896,
//         -0.06325625628232956
//     ],
//     metadata: {
//       userId: 'u1',
//       workspaceId: 'workspace'
//     }}])